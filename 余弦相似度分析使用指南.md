# ä½™å¼¦ç›¸ä¼¼åº¦çŸ©é˜µæ‰“å° - ä½¿ç”¨æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

è¿™äº›è„šæœ¬ç”¨äºè®¡ç®—å’Œå¯è§†åŒ–GDNæ¨¡å‹ä¸­èŠ‚ç‚¹åµŒå…¥(Embedding)çš„ä½™å¼¦ç›¸ä¼¼åº¦çŸ©é˜µã€‚ä½™å¼¦ç›¸ä¼¼åº¦çŸ©é˜µå¯ä»¥å¸®åŠ©ä½ ç†è§£:
- å“ªäº›ä¼ æ„Ÿå™¨/èŠ‚ç‚¹åœ¨æ¨¡å‹å­¦ä¹ ä¸­è¢«è®¤ä¸ºæ˜¯ç›¸å…³çš„
- èŠ‚ç‚¹åµŒå…¥çš„è´¨é‡å’Œåˆ†å¸ƒæƒ…å†µ
- æ¨¡å‹å­¦ä¹ åˆ°çš„å›¾ç»“æ„

## ğŸ“ æ–‡ä»¶è¯´æ˜

### 1. `print_cosine_similarity.py` (å®Œæ•´ç‰ˆ)
åŠŸèƒ½æœ€å…¨é¢çš„ç‰ˆæœ¬,åŒ…å«:
- âœ… å‘½ä»¤è¡Œå‚æ•°æ”¯æŒ
- âœ… è¯¦ç»†çš„ç»Ÿè®¡ä¿¡æ¯
- âœ… å¯è§†åŒ–çƒ­åŠ›å›¾
- âœ… æœ€ç›¸ä¼¼èŠ‚ç‚¹å¯¹æŸ¥æ‰¾

### 2. `print_cosine_similarity_simple.py` (ç®€åŒ–ç‰ˆ)
ç®€å•æ˜“ç”¨çš„ç‰ˆæœ¬,å¯ä»¥:
- âœ… åœ¨ä»£ç ä¸­ç›´æ¥è°ƒç”¨
- âœ… å¿«é€Ÿæ‰“å°ç›¸ä¼¼åº¦çŸ©é˜µ
- âœ… ä¿å­˜ä¸ºCSVæ–‡ä»¶

---

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### æ–¹æ³•1: å‘½ä»¤è¡Œè¿è¡Œ(å®Œæ•´ç‰ˆ)

```bash
# åŸºæœ¬ç”¨æ³•
python print_cosine_similarity.py --model_path checkpoints/swat_best.pt

# å®Œæ•´å‚æ•°ç¤ºä¾‹
python print_cosine_similarity.py \
    --model_path checkpoints/swat_best.pt \
    --node_num 27 \
    --dim 64 \
    --input_dim 10 \
    --topk 20 \
    --top_n 10 \
    --save_fig \
    --fig_path results/cosine_similarity.png
```

**å‚æ•°è¯´æ˜:**
- `--model_path`: (å¿…éœ€) æ¨¡å‹æƒé‡æ–‡ä»¶è·¯å¾„
- `--node_num`: èŠ‚ç‚¹æ•°é‡,é»˜è®¤27 (SWaTæ•°æ®é›†)
- `--dim`: åµŒå…¥ç»´åº¦,é»˜è®¤64
- `--input_dim`: è¾“å…¥ç‰¹å¾ç»´åº¦,é»˜è®¤10
- `--topk`: TopKå‚æ•°,é»˜è®¤20
- `--top_n`: æ‰“å°å‰Nä¸ªèŠ‚ç‚¹çš„å­çŸ©é˜µ,é»˜è®¤5
- `--save_fig`: æ˜¯å¦ä¿å­˜çƒ­åŠ›å›¾
- `--fig_path`: çƒ­åŠ›å›¾ä¿å­˜è·¯å¾„

---

### æ–¹æ³•2: åœ¨è®­ç»ƒè„šæœ¬ä¸­è°ƒç”¨(ç®€åŒ–ç‰ˆ)

#### æ–¹å¼A: è®­ç»ƒç»“æŸåç«‹å³åˆ†æ

åœ¨ `train.py` çš„è®­ç»ƒå‡½æ•°æœ«å°¾æ·»åŠ :

```python
# åœ¨ train.py çš„ train å‡½æ•°æœ«å°¾æ·»åŠ 
def train(model=None, ...):
    # ... åŸæœ‰çš„è®­ç»ƒä»£ç  ...
    
    # è®­ç»ƒå®Œæˆåæ‰“å°ä½™å¼¦ç›¸ä¼¼åº¦
    from print_cosine_similarity_simple import print_cosine_similarity_simple
    print("\n" + "="*80)
    print("è®­ç»ƒå®Œæˆ! åˆ†æèŠ‚ç‚¹åµŒå…¥ä½™å¼¦ç›¸ä¼¼åº¦:")
    print("="*80)
    cos_sim = print_cosine_similarity_simple(model, top_n=10)
    
    return train_loss_list
```

#### æ–¹å¼B: åœ¨main.pyä¸­è®­ç»ƒååˆ†æ

åœ¨ `main.py` ä¸­è®­ç»ƒå®Œæˆå:

```python
# åœ¨ main.py ä¸­è®­ç»ƒå®Œæˆå
from print_cosine_similarity_simple import print_cosine_similarity_simple, save_cosine_similarity_to_file

# è®­ç»ƒ
train_loss = train(model, ...)

# åˆ†æä½™å¼¦ç›¸ä¼¼åº¦
print("\nåˆ†æè®­ç»ƒåçš„èŠ‚ç‚¹åµŒå…¥...")
cos_sim = print_cosine_similarity_simple(model, top_n=10)
save_cosine_similarity_to_file(model, f'results/{dataset_name}_cosine_similarity.csv')
```

#### æ–¹å¼C: åŠ è½½å·²æœ‰æ¨¡å‹åˆ†æ

åˆ›å»ºä¸€ä¸ªæ–°çš„åˆ†æè„šæœ¬:

```python
# analyze_embeddings.py
import torch
from models.GDN import GDN
from util.env import get_device
from print_cosine_similarity_simple import print_cosine_similarity_simple

# é…ç½®
MODEL_PATH = 'checkpoints/swat_best.pt'
NODE_NUM = 27
DIM = 64

# åŠ è½½æ¨¡å‹
device = get_device()
edge_index = torch.zeros((2, NODE_NUM * 20), dtype=torch.long)
model = GDN(
    edge_index_sets=[edge_index],
    node_num=NODE_NUM,
    dim=DIM,
    input_dim=10,
    topk=20
).to(device)

model.load_state_dict(torch.load(MODEL_PATH, map_location=device))

# æ‰“å°ä½™å¼¦ç›¸ä¼¼åº¦
print_cosine_similarity_simple(model, top_n=10)
```

---

### æ–¹æ³•3: ç›´æ¥ä¿®æ”¹å¹¶è¿è¡Œç®€åŒ–ç‰ˆè„šæœ¬

1. æ‰“å¼€ `print_cosine_similarity_simple.py`
2. ä¿®æ”¹æ–‡ä»¶æœ«å°¾çš„å‚æ•°:
```python
# === ä¿®æ”¹è¿™é‡Œçš„å‚æ•° ===
MODEL_PATH = 'checkpoints/swat_best.pt'  # ä½ çš„æ¨¡å‹è·¯å¾„
NODE_NUM = 27  # èŠ‚ç‚¹æ•°é‡
DIM = 64  # åµŒå…¥ç»´åº¦
# =====================
```
3. è¿è¡Œ:
```bash
python print_cosine_similarity_simple.py
```

---

## ğŸ“Š è¾“å‡ºç¤ºä¾‹

è¿è¡Œè„šæœ¬å,ä½ ä¼šçœ‹åˆ°ç±»ä¼¼ä»¥ä¸‹çš„è¾“å‡º:

```
================================================================================
ä½™å¼¦ç›¸ä¼¼åº¦çŸ©é˜µ:
================================================================================
Shape: torch.Size([27, 27])
Min: -0.3245
Max: 1.0000
Mean: 0.1234

å¯¹è§’çº¿ (è‡ªå·±ä¸è‡ªå·±):
  Min: 1.0000
  Max: 1.0000
  ç¤ºä¾‹: [1. 1. 1. 1. 1.]

å‰5ä¸ªä¼ æ„Ÿå™¨çš„ç›¸ä¼¼åº¦çŸ©é˜µ:
--------------------------------------------------------------------------------
      Node 0  Node 1  Node 2  Node 3  Node 4
Node 0  1.0000  0.4523  0.2341  0.1234 -0.0234
Node 1  0.4523  1.0000  0.6234  0.3456  0.1234
Node 2  0.2341  0.6234  1.0000  0.4567  0.2345
Node 3  0.1234  0.3456  0.4567  1.0000  0.5678
Node 4 -0.0234  0.1234  0.2345  0.5678  1.0000
================================================================================

ğŸ† ç›¸ä¼¼åº¦æœ€é«˜çš„10ä¸ªèŠ‚ç‚¹å¯¹:
--------------------------------------------------------------------------------
 1. Node  3 â†” Node 12  |  ç›¸ä¼¼åº¦: 0.823456
 2. Node  5 â†” Node 18  |  ç›¸ä¼¼åº¦: 0.789012
 3. Node  1 â†” Node  9  |  ç›¸ä¼¼åº¦: 0.756789
...
```

---

## ğŸ¨ å¯è§†åŒ–

å®Œæ•´ç‰ˆè„šæœ¬å¯ä»¥ç”Ÿæˆçƒ­åŠ›å›¾:

```bash
python print_cosine_similarity.py \
    --model_path checkpoints/swat_best.pt \
    --save_fig \
    --fig_path results/similarity_heatmap.png
```

çƒ­åŠ›å›¾è¯´æ˜:
- ğŸ”´ çº¢è‰²: é«˜ç›¸ä¼¼åº¦ (æ¥è¿‘1)
- ğŸŸ¡ é»„è‰²: ä¸­ç­‰ç›¸ä¼¼åº¦ (æ¥è¿‘0)
- ğŸ”µ è“è‰²: ä½ç›¸ä¼¼åº¦ (æ¥è¿‘-1)
- å¯¹è§’çº¿åº”è¯¥å…¨æ˜¯çº¢è‰² (è‡ªå·±ä¸è‡ªå·±çš„ç›¸ä¼¼åº¦ä¸º1)

---

## ğŸ’¡ ä½¿ç”¨æŠ€å·§

### 1. **åœ¨è®­ç»ƒä¸åŒepochåå¯¹æ¯”**
```python
# ä¿å­˜ä¸åŒepochçš„ç›¸ä¼¼åº¦çŸ©é˜µ
for epoch in [10, 50, 100]:
    # åŠ è½½å¯¹åº”epochçš„æ¨¡å‹
    model.load_state_dict(torch.load(f'checkpoints/model_epoch_{epoch}.pt'))
    cos_sim = print_cosine_similarity_simple(model)
    save_cosine_similarity_to_file(model, f'results/cosine_epoch_{epoch}.csv')
```

### 2. **åˆ†æç‰¹å®šèŠ‚ç‚¹çš„å…³ç³»**
```python
# æŸ¥çœ‹æŸä¸ªèŠ‚ç‚¹ä¸æ‰€æœ‰å…¶ä»–èŠ‚ç‚¹çš„ç›¸ä¼¼åº¦
node_id = 5
similarities = cos_similarity[node_id, :]
print(f"Node {node_id} ä¸å…¶ä»–èŠ‚ç‚¹çš„ç›¸ä¼¼åº¦:")
for i, sim in enumerate(similarities):
    print(f"  Node {i}: {sim.item():.4f}")
```

### 3. **æ‰¾å‡ºå­¤ç«‹èŠ‚ç‚¹**
```python
# æ‰¾å‡ºå¹³å‡ç›¸ä¼¼åº¦æœ€ä½çš„èŠ‚ç‚¹
avg_similarities = cos_similarity.mean(dim=1)
isolated_nodes = torch.argsort(avg_similarities)[:5]  # æœ€å­¤ç«‹çš„5ä¸ªèŠ‚ç‚¹
print("æœ€å­¤ç«‹çš„èŠ‚ç‚¹:", isolated_nodes.cpu().numpy())
```

### 4. **èšç±»åˆ†æ**
```python
from sklearn.cluster import KMeans

# åŸºäºä½™å¼¦ç›¸ä¼¼åº¦è¿›è¡Œèšç±»
embeddings = model.embedding.weight.cpu().detach().numpy()
kmeans = KMeans(n_clusters=5)
labels = kmeans.fit_predict(embeddings)
print("èŠ‚ç‚¹èšç±»æ ‡ç­¾:", labels)
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ¨¡å‹å¿…é¡»å·²è®­ç»ƒ**: ç¡®ä¿æ¨¡å‹æƒé‡æ–‡ä»¶å­˜åœ¨ä¸”å·²ç»è¿‡è®­ç»ƒ
2. **å‚æ•°åŒ¹é…**: `node_num`, `dim` ç­‰å‚æ•°å¿…é¡»ä¸è®­ç»ƒæ—¶ä¸€è‡´
3. **è®¾å¤‡å…¼å®¹**: è„šæœ¬ä¼šè‡ªåŠ¨å¤„ç†CPU/GPU,ä½†ç¡®ä¿æ¨¡å‹æ–‡ä»¶å¯ä»¥åœ¨å½“å‰è®¾å¤‡åŠ è½½
4. **å†…å­˜å ç”¨**: å¦‚æœèŠ‚ç‚¹æ•°å¾ˆå¤§(>1000),å¯è§†åŒ–å¯èƒ½ä¼šå ç”¨è¾ƒå¤šå†…å­˜

---

## ğŸ”§ æ•…éšœæ’é™¤

### é—®é¢˜1: æ‰¾ä¸åˆ°æ¨¡å‹æ–‡ä»¶
```
FileNotFoundError: æ¨¡å‹æ–‡ä»¶ä¸å­˜åœ¨: checkpoints/swat_best.pt
```
**è§£å†³æ–¹æ³•**: æ£€æŸ¥æ¨¡å‹è·¯å¾„æ˜¯å¦æ­£ç¡®,ç¡®ä¿å·²ç»è®­ç»ƒè¿‡æ¨¡å‹

### é—®é¢˜2: æ¨¡å‹å‚æ•°ä¸åŒ¹é…
```
RuntimeError: Error(s) in loading state_dict...
```
**è§£å†³æ–¹æ³•**: ç¡®ä¿ `node_num`, `dim` ç­‰å‚æ•°ä¸è®­ç»ƒæ—¶ä¸€è‡´

### é—®é¢˜3: å¯¹è§’çº¿ä¸å…¨æ˜¯1
```
å¯¹è§’çº¿ Min: 0.9998  Max: 1.0002
```
**è¯´æ˜**: ç”±äºæµ®ç‚¹æ•°ç²¾åº¦é—®é¢˜,å¯¹è§’çº¿å€¼å¯èƒ½ä¸æ˜¯ç²¾ç¡®çš„1.0,ä½†åº”è¯¥éå¸¸æ¥è¿‘(0.9999-1.0001)

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- GDNæ¨¡å‹ç»“æ„: `models/GDN.py`
- è®­ç»ƒæµç¨‹: `train.py`
- æ•°æ®å¤„ç†: `util/data.py`

---

## ğŸ¤ é›†æˆåˆ°ç°æœ‰å·¥ä½œæµ

### é›†æˆåˆ°è®­ç»ƒæµç¨‹

ä¿®æ”¹ `main.py`:

```python
# åœ¨ main.py ä¸­
def main():
    # ... åŸæœ‰ä»£ç  ...
    
    # è®­ç»ƒ
    train_loss = train(model, save_path, config, ...)
    
    # === æ·»åŠ è¿™éƒ¨åˆ† ===
    # åˆ†æè®­ç»ƒåçš„èŠ‚ç‚¹åµŒå…¥
    from print_cosine_similarity_simple import print_cosine_similarity_simple, save_cosine_similarity_to_file
    
    print("\n" + "="*80)
    print("ğŸ“Š è®­ç»ƒå®Œæˆ! åˆ†æèŠ‚ç‚¹åµŒå…¥ä½™å¼¦ç›¸ä¼¼åº¦")
    print("="*80)
    
    cos_sim = print_cosine_similarity_simple(model, top_n=10)
    
    # ä¿å­˜åˆ°ç»“æœç›®å½•
    import os
    result_dir = os.path.join('results', dataset)
    os.makedirs(result_dir, exist_ok=True)
    save_cosine_similarity_to_file(
        model, 
        os.path.join(result_dir, f'{dataset}_cosine_similarity.csv')
    )
    # === ç»“æŸæ·»åŠ  ===
    
    # ... åŸæœ‰ä»£ç  ...
```

è¿™æ ·æ¯æ¬¡è®­ç»ƒå®Œæˆåéƒ½ä¼šè‡ªåŠ¨åˆ†æå¹¶ä¿å­˜ä½™å¼¦ç›¸ä¼¼åº¦çŸ©é˜µ!

---

## ğŸ“§ é—®é¢˜åé¦ˆ

å¦‚æœ‰é—®é¢˜,è¯·æ£€æŸ¥:
1. æ¨¡å‹æ˜¯å¦å·²æ­£ç¡®è®­ç»ƒ
2. å‚æ•°è®¾ç½®æ˜¯å¦ä¸è®­ç»ƒæ—¶ä¸€è‡´
3. æ‰€æœ‰ä¾èµ–åº“æ˜¯å¦å·²å®‰è£… (torch, numpy, matplotlib, seaborn)
